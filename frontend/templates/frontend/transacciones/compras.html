{% extends 'global/base.html' %}
{% load static %}


{% block title %}
Compras
{% endblock %}


{% block content %}
<div class="container-scroller">
    {% include 'global/components/navbar.html' %}
    <!-- Content -->
    <div class="container-fluid page-body-wrapper">
        {% include 'global/components/sidebar.html' %}
        <div class="main-panel">
            {% include 'global/components/loader.html' %}
            <div class="content-wrapper loader-await" id="content-compras">
                <div class="col-12 grid-margin">
                    <h1 class="text-light bg-dark pl-1 display-1">Listado de compras</h1>
                    <div class="card">
                        <div class="card-body">
                            <a class="btn btn-outline-success btn-fw" href="{% url 'frontend:compra_nueva' %}">
                                Crear Compra
                            </a>
                        </div>
                    </div>
                </div>
                <div class="col-12 grid-margin">
                    <div class="card">
                        <div class="card-body">
                            <h4 class="card-title">Listado general de compras</h4>
                            <div class="row">
                                <div class="col-12">
                                    <div class="table-responsive">
                                        <table class="table table-hover data-table">
                                            <thead>
                                                <tr>
                                                    <th>#</th>
                                                    <th>Fecha</th>
                                                    <th>Anotaciones</th>
                                                    <th>Proveedor</th>
                                                    <th>Total</th>
                                                    <th>Opciones</th>
                                                </tr>
                                            </thead>
                                            <tbody id='compras-t-body'>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% include 'global/components/footer.html' %}
        </div>
        <!-- main-panel ends -->
    </div>
    <!-- page-body-wrapper ends -->
</div>
<!-- container-scroller -->
{% endblock %}


{% block js %}
<script src="{% static 'global/js/transacciones/script.js' %}"></script>
<script>
    const getCompras = async () => {
        try {
            MostrarLoader()
            const {
                data
            } = await axios.get('compras/')
            if (!data[0]) showAlert('error-message', {
                title: 'No existen compras registradas'
            })
            let cont = 0
            let comrpasHtml = ''
            for(compra of data){
                cont++
                let fecha  = 'N/A'
                if (compra.fecha_hora_creacion) fecha = moment(compra.fecha_hora_creacion, 'Y-MM-DD').format('DD/MM/Y')
                comrpasHtml += `
                    <tr>
                        <td>${cont}</td>
                        <td>${fecha}</td>
                        <td>${compra.observaciones}</td>
                        <td>${compra.proveedor.nombre}</td>
                        <td>Q${compra.total}</td>
                        <td>
                            <i class="mdi mdi-eye-outline mr-3" onclick="window.location.href='${compra.id}/'"></i>
                            <i class="mdi mdi-trash-can" onclick="CompraEliminar(${compra.id})"></i>
                        </td>
                    </tr>
                `
            }
            $('#compras-t-body').html(comrpasHtml)
            InitDataTable()
            OcultarLoader()
        } catch (err) {
            OcultarLoader()
            showAlert('error-message', {
                title: 'No se pudieron cargar las compras, intente mas tarde'
            })
        }
    }
    ( async () => {
        await getCompras()
        await ValidarPermisos()
    }) ()
</script>
{% endblock %}